@model QLDA.Models.tbl_CongViec



<section class="content">
    <div class="container-fluid card col-md-10 m-auto">
        <div>
            <h4 class="mt-3">Chi tiết công việc --@Model.MucTieu-- của dự án --@Model.tbl_DuAn.TenDuAn--</h4>
            <hr />
            <dl class="dl-horizontal">
                <dt>
                    @Html.HiddenFor(model => model.MaCongViec, new { @id = "MaCongViec" })
                    @Html.DisplayNameFor(model => model.MucTieu)
                </dt>

                <dd>
                    @Html.DisplayFor(model => model.MucTieu)
                </dd>

                <dt>
                    @Html.DisplayNameFor(model => model.ThoiGianHoanThanh)
                </dt>

                <dd>
                    @Html.DisplayFor(model => model.ThoiGianHoanThanh)
                </dd>

                <dt>
                    @Html.DisplayNameFor(model => model.ChiThietCongViec)
                </dt>

                <dd>
                    @Html.DisplayFor(model => model.ChiThietCongViec)
                </dd>

                <dt>
                    @Html.DisplayNameFor(model => model.TienDo)
                </dt>

                <dd>
                    @Html.DisplayFor(model => model.TienDo)
                </dd>

                <dt>
                    @Html.DisplayNameFor(model => model.NgayTao)
                </dt>

                <dd>
                    @Html.DisplayFor(model => model.NgayTao)
                </dd>

                <dt>
                    @Html.DisplayNameFor(model => model.TrangThai)
                </dt>

                <dd>
                    @Html.DisplayFor(model => model.TrangThai)
                </dd>

                <dt>
                    @Html.DisplayNameFor(model => model.tbl_DuAn.TenDuAn)
                </dt>

                <dd>
                    @Html.DisplayFor(model => model.tbl_DuAn.TenDuAn)
                </dd>

            </dl>
        </div>



        <form class="form-group mt-3" id="add" action="" method="post">
            <select class="col-md-10" id="MaNV" name="MaNV">
                @*@Html.DropDownList("MaNV", null, htmlAttributes: new { @class = "form-control" })*@
                @{ Html.RenderAction("dsNhanVienInDuAn", "CongViec");}

            </select>

            <input type="button" value="Thêm nhân viên" id="addNhanVien" onclick="SubmitForm()" />
        </form>

        <h4>Danh sách nhân viên trong công việc</h4>
        <div class="card-body table-responsive p-0">
            <table class="table table-hover text-nowrap border border-info">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Tên nhân viên</th>
                        <th>Chức năng</th>
                    </tr>
                </thead>
                <tbody id="dvPartial">
                    @{ Html.RenderAction("dsNhanVienInCongViec", "CongViec");}
                </tbody>
            </table>
        </div>

        <!--<p class="mt-3 d-flex flex-row-reverse ">
        @Html.ActionLink("Edit", "Edit", new { id = Model.MaDuAn }, new { @class = "btn btn-sm btn-info " })
        @Html.ActionLink("Quay lại", "Index", null, new { @class = "btn btn-sm btn-secondary mr-3" })-->
        @*<a href="/Admin/ThamGiaDuAn/Create/@Model.MaDuAn">Thêm thành viên</a>*@
        <!--</p>-->

        <div class="d-flex justify-content-between mt-4 mb-2">

            <h4 class="">Danh sách công việc nhỏ hơn</h4>
            <button type="button" style="height: 100%" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal">
                Thêm công việc
            </button>

        </div>



        <!-- Button trigger modal -->
        <!-- Modal -->
        <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Thêm công việc</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <fieldset style="position: relative">
                            <input type="text" id="tenCongViec2" class="form-control mr-1" placeholder="Nhập tên công việc" />
                            <p style="position: absolute; top: 45px; color:red; font-size:12px" id="error1"></p>
                        </fieldset>

                        <fieldset style="position: relative" class="mt-3">
                            <input type="text" id="chiTiet" class="form-control mr-1 mt-3" placeholder="Chi tiết công việc" />
                            <p style="position: absolute; top: 45px; color:red; font-size:12px" id="error2"></p>
                        </fieldset>

                        <fieldset style="position: relative" class="mt-3">
                            <input type="number" min="0" id="KhoiLuong" class="form-control mr-1 mt-3" placeholder="Khối lượng công việc" step="0.01" value="0.00" />
                            <p style="position: absolute; top: 45px; color:red; font-size:12px" id="error3"></p>
                        </fieldset>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="themCongViec()">Lưu</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card-body table-responsive p-0">
            <table class="table table-hover text-nowrap border border-info">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Mục tiêu công việc</th>
                        <th>Deadline</th>
                        <th>Tiến độ</th>
                        <th>Trạng thái</th>
                    </tr>
                </thead>
                <tbody id="dvPartial">
                    @{ Html.RenderAction("dsCongViecCap2", "CongViecCap2");}
                </tbody>
            </table>
        </div>



        <p class="mt-3 d-flex flex-row-reverse ">
            @Html.ActionLink("Edit", "Edit", new { id = Model.MaCongViec }, new { @class = "btn btn-sm btn-info " })
            <a href="/Admin/CongViec/Index" class="btn btn-sm btn-secondary mr-3">Quay lại danh sách</a>
            <a href="/Admin/DuAn/Details/@Model.tbl_DuAn.MaDuAn" class="btn btn-sm btn-secondary mr-3">Quay lại</a>
        </p>

    </div>
</section>



@section scripts{
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&key=AIzaSyCIwF204lFZg1y4kPSIhKaHEXMLYxxuMhA"></script>
    <script src="~/Content/Admin/plugins/jquery/jquery.min.js"></script>
    <script src="~/Content/Admin/plugins/jquery-ui/jquery-ui.min.js"></script>
    <script>

        $(document).ready(function () {
            window.deleteNhanVien = deleteNhanVien;
            window.SubmitForm = SubmitForm;
            window.ghichu = ghichu;
            window.themCongViec = themCongViec
            window.suaCongViec2 = suaCongViec2;
            window.xoaCongViec2 = xoaCongViec2;

        });
        // nhan vien start
        function SubmitForm() {
            _maCV = $("#MaCongViec").val();
            _maNV = $("#MaNV").val();
            $.ajax({
                type: "POST",
                url: "/NhanVienThamGiaCongViec/addNhanVien",
                data: { maCongViec: _maCV, idNv: _maNV },
                success: function (data) {
                    if (data.message) {
                        alert("Thêm nhân viên vào công việc thành công");
                        location.reload();
                    }
                    else {
                        alert("Thêm nhân viên thất bại");
                    }
                }
            });
        }


        function deleteNhanVien(idnv) {
            _maCV = $("#MaCongViec").val();
            //_maNV = $("#maNv").val();
            //var idnv = $(this).data("maNv");
            $.ajax({
                type: "POST",
                url: "/NhanVienThamGiaCongViec/deleteNhanVien",
                data: { maCv: _maCV, maNv: idnv },
                success: function (data) {
                    if (data.message) {
                        /*alert("Xóa thành công");*/
                        location.reload();
                    }
                    else {
                        alert("Xóa thất bại");
                    }
                },
                error: function (xhr, status, error) {
                    // Hoặc:
                }
            });
        }
        // nhan vien end

         // công việc start
        function themCongViec() {
            _maCV = $("#MaCongViec").val();
            _tenCongViec = $("#tenCongViec2").val();
            _chiTiet = $("#chiTiet").val();
            _deadLine = $("#KhoiLuong").val();

            error1 = $("#error1");
            if ($("#tenCongViec2").val() == "") {
                error1.html("Vui lòng nhập tên công việc!");
                //alert("Chưa nhập tên khách hàng");
                return;
            }

            error2 = $("#error2");
            if ($("#chiTiet").val() == "") {
                error1.html("Vui lòng nhập chi tiết công việc!");
                //alert("Chưa nhập tên khách hàng");
                return;
            }

            error3 = $("#error3");
            if ($("#tenCongViec2").val() == "") {
                error1.html("Vui lòng cho biết thời gian hoàn thành!");
                //alert("Chưa nhập tên khách hàng");
                return;
            }


            $.ajax({
                type: "POST",
                url: "/CongViecCap2/addCongViec2",
                data: { maCv: _maCV, tenCv: _tenCongViec, chiTiet: _chiTiet, deadLine: _deadLine },
                success: function (data) {
                    if (data.message) {
                        /*alert("Thêm nhân viên vào dự án thành công");*/
                        location.reload();
                    }
                    else {
                        alert("Thêm công việc thất bại");
                    }
                }
            });
        }

        function suaCongViec2(maCongViec2) {
            
            _tenCv = $("#tenCvEdit-" + maCongViec2).val();
            _chiTiet = $("#chiTietEdit-" + maCongViec2).val();
            
            _tg = $("#KhoiLuong-" + maCongViec2).val();
          

            $.ajax({
                type: "POST",
                url: "/CongViecCap2/editCongViec2",
                data: { MaCongViec: maCongViec2, tenCv: _tenCv, chiTiet: _chiTiet, tg: _tg },
                success: function (data) {

                    if (data.message) {
                        alert("Cập nhật công việc thành công");
                        location.reload();
                    }
                    else {
                        alert("Cập nhật công việc thất bại");
                    }
                }
            });
        }

        function xoaCongViec2(idCongViec) {
            
            $.ajax({
                type: "POST",
                url: "/CongViecCap2/deleteCongViec2",
                data: { maCongViec: idCongViec },
                success: function (data) {
                    if (data.message) {
                        /*alert("Xóa thành công");*/
                        location.reload();
                    }
                    else {
                        alert("Xóa thất bại");
                    }
                },
                error: function (xhr, status, error) {
                    // Hoặc:
                }
            });
        }

            // công việc end





    </script>

}


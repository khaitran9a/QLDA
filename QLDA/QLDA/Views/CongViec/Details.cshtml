@model QLDA.Models.tbl_CongViec

@{
    ViewBag.Title = "Details";
    Layout = "~/Views/Shared/_Layout.cshtml";


    int userID = (int)Session["UserID"];

    var query = Model.tbl_NhanVienThamGiaCongViec.FirstOrDefault(x => x.MaCongViec == Model.MaCongViec && x.MaNV == userID);
    bool isManager = false;

    if (query.isManager != null)
    {
        isManager = (bool)query.isManager;
    }
}
@if (!isManager && Model.tbl_NhanVienThamGiaCongViec.Count() == 1)
{
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0"></h1>
                </div><!-- /.col -->

            </div><!-- /.row -->
        </div><!-- /.container-fluid -->
    </div>
    <div class="pt-4" style="padding-top: 80px !important">
        <h4>Chi tiết công việc : @Model.MucTieu</h4>
        <hr />
        <dl class="dl-horizontal">
            <dt>
                @Html.HiddenFor(model => model.MaCongViec, new { @id = "MaCongViec" })
                @Html.DisplayNameFor(model => model.MucTieu)
            </dt>
            <dt>
                @Html.DisplayNameFor(model => model.MucTieu)
            </dt>

            <dd>
                @Html.DisplayFor(model => model.MucTieu, new { @id = "MucTieu" })
            </dd>

            <dt>
                @Html.DisplayNameFor(model => model.ThoiGianHoanThanh)
            </dt>

            <dd>
                @Html.DisplayFor(model => model.ThoiGianHoanThanh, new { @id = "KhoiLuong" })
            </dd>

            <dt>
                @Html.DisplayNameFor(model => model.ChiThietCongViec)
            </dt>

            <dd>
                @Html.DisplayFor(model => model.ChiThietCongViec, new { @id = "ChchiaiTiet" })
            </dd>

            <dt>
                @Html.DisplayNameFor(model => model.TienDo)
            </dt>

            <dd>
                @Html.DisplayFor(model => model.TienDo) %
            </dd>

            <dt>
                @Html.DisplayNameFor(model => model.NgayTao)
            </dt>

            <dd>
                @Html.DisplayFor(model => model.NgayTao)
            </dd>

            <dt>
                @Html.DisplayNameFor(model => model.TrangThai)
            </dt>

            <dd>
                @Html.DisplayFor(model => model.TrangThai)
            </dd>

            <dt>
                @Html.DisplayNameFor(model => model.ParentID)
            </dt>

            <dd>
                @Html.DisplayFor(model => model.ParentID)
            </dd>

            <dt>
                @Html.DisplayNameFor(model => model.tbl_DuAn.TenDuAn)
            </dt>

            <dd>
                @Html.DisplayFor(model => model.tbl_DuAn.TenDuAn)

            </dd>
            <dd>
                @Html.HiddenFor(model => model.MaDuAn, new { @id = "MaDuAn" })
            </dd>

        </dl>
        @if (Model.TienDo == 100)
        {
            <p class="text-success"> Đã hoàn thành</p>
        }
        else
        {
            <div class="d-flex justify-content-sm-start mt-4 mb-2">

                <button style="height: 100%" class="btn btn-primary mr-4" onclick="hoanThanh(@Model.MaCongViec)">
                    Hoàn Thành
                </button>

                <button style="height: 100%" class="btn btn-primary mr-4"  data-toggle="modal" data-target="#daLam">
                    Đã làm
                </button>

                <button style="height: 100%" class="btn btn-secondary" data-toggle="modal" data-target="#chuyenViecModal">
                    Chuyển giao công việc
                </button>


            </div>

            <div class="modal fade" style="padding-top: 300px; border: 1px solid red" id="daLam" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Chuyển giao việc</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">


                            <fieldset style="position: relative" class="mt-3">
                                <label for="khoiLuongDaLam">Khối lượng công việc đã làm </label>
                                <input type="number" min="0" max="@Model.ThoiGianHoanThanh" id="khoiLuongDaLam" class="form-control mr-1 mt-3" placeholder="Thời gian hoàn thành" step="0.01" value="0.00" />
                                <p style="position: absolute; top: 45px; color:red; font-size:12px" id="error3"></p>
                            </fieldset>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary" onclick="daLam(@Model.MaCongViec)">Lưu </button>
                        </div>

                    </div>
                </div>
            </div>

        }

        <!-- Modal chuyen viec -->
        <div class="modal fade" style="padding-top: 300px; border: 1px solid red" id="chuyenViecModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Chuyển giao việc</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">


                        <fieldset style="position: relative" class="mt-3">
                            <label for="nhaVienDuocChuyenViec">Chuyển giao cho nhân viên</label> <br />
                            <select id="nhaVienDuocChuyenViec">
                                @Html.Action("dsNhanVienTrongCongViec", "CongViec")
                            </select>
                        </fieldset>

                        <fieldset style="position: relative" class="mt-3">
                            <label for="thoiGianHoanThanh">Khối lượng công việc đã làm </label>
                            <input type="number" min="0" max="@Model.ThoiGianHoanThanh" id="thoiGianHoanThanh" class="form-control mr-1 mt-3" placeholder="Thời gian hoàn thành" step="0.01" value="0.00" />
                            <p style="position: absolute; top: 45px; color:red; font-size:12px" id="error3"></p>
                        </fieldset>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary" onclick="chiaViec2()">Lưu </button>
                    </div>

                </div>
            </div>
        </div>
    </div>
}
else if(isManager)
{
    <h2>Đây là manager</h2>

    <section class="content">
        <div class="container-fluid card col-md-10 m-auto">
            <div>
                <h4 class="mt-3">Chi tiết công việc --@Model.MucTieu-- của dự án --@Model.tbl_DuAn.TenDuAn--</h4>
                <hr />
                <dl class="dl-horizontal">
                    <dt>
                        @Html.HiddenFor(model => model.MaCongViec, new { @id = "MaCongViec" })
                        @Html.DisplayNameFor(model => model.MucTieu)
                    </dt>

                    <dd>
                        @Html.DisplayFor(model => model.MucTieu)
                    </dd>

                    <dt>
                        @Html.DisplayNameFor(model => model.ThoiGianHoanThanh)
                    </dt>

                    <dd>
                        @Html.DisplayFor(model => model.ThoiGianHoanThanh)
                    </dd>

                    <dt>
                        @Html.DisplayNameFor(model => model.ChiThietCongViec)
                    </dt>

                    <dd>
                        @Html.DisplayFor(model => model.ChiThietCongViec)
                    </dd>

                    <dt>
                        @Html.DisplayNameFor(model => model.TienDo)
                    </dt>

                    <dd>
                        @Html.DisplayFor(model => model.TienDo)
                    </dd>
                    <dd>
                        @Html.DisplayFor(model => model.TienDo)
                    </dd>

                    <dd>
                        @Html.HiddenFor(model => model.MaDuAn, new { @id = "MaDuAn" })
                    </dd>



                    <dt>
                        @Html.DisplayNameFor(model => model.NgayTao)
                    </dt>

                    <dd>
                        @Html.DisplayFor(model => model.NgayTao)
                    </dd>

                    <dt>
                        @Html.DisplayNameFor(model => model.TrangThai)
                    </dt>

                    <dd>
                        @Html.DisplayFor(model => model.TrangThai)
                    </dd>

                    <dt>
                        @Html.DisplayNameFor(model => model.tbl_DuAn.TenDuAn)
                    </dt>

                    <dd>
                        @Html.DisplayFor(model => model.tbl_DuAn.TenDuAn)
                    </dd>

                </dl>
            </div>

            <form class="form-group mt-3" id="add" action="" method="post">
                <select class="col-md-10" id="MaNV" name="MaNV">
                    @*@Html.DropDownList("MaNV", null, htmlAttributes: new { @class = "form-control" })*@
                    @{ Html.RenderAction("dsNhanVienInDuAn", "CongViec", new { area = "Admin" });}

                </select>

                <input type="button" value="Thêm nhân viên" id="addNhanVien" onclick="SubmitForm(@Model.MaCongViec)" />
            </form>

            <h4>Danh sách nhân viên trong công việc</h4>
            <div class="card-body table-responsive p-0">
                <table class="table table-hover text-nowrap border border-info">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Tên nhân viên</th>
                            <th>Chức năng</th>
                        </tr>
                    </thead>
                    <tbody id="dvPartial">
                        @{ Html.RenderAction("dsNhanVienTrongCongViec", "NhanVienThamGiaCongViec");}
                    </tbody>
                </table>
            </div>

            <!--<p class="mt-3 d-flex flex-row-reverse ">
            @Html.ActionLink("Edit", "Edit", new { id = Model.MaDuAn }, new { @class = "btn btn-sm btn-info " })
            @Html.ActionLink("Quay lại", "Index", null, new { @class = "btn btn-sm btn-secondary mr-3" })-->
            @*<a href="/Admin/ThamGiaDuAn/Create/@Model.MaDuAn">Thêm thành viên</a>*@
            <!--</p>-->

            <div class="d-flex justify-content-between mt-4 mb-2">

                <h4 class="">Danh sách công việc nhỏ hơn</h4>
                <button type="button" style="height: 100%" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal">
                    Thêm công việc
                </button>

            </div>



            <!-- Button trigger modal -->
            <!-- Modal -->
            @if (Model.tbl_NhanVienThamGiaCongViec.Count() < 2)
            {
                <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="exampleModalLabel">Có 1 mình tự làm đi ba!</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>

                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>

                            </div>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="exampleModalLabel">Thêm công việc</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <fieldset style="position: relative">
                                    <input type="text" id="tenCongViec" class="form-control mr-1" placeholder="Nhập tên công việc" />
                                    <p style="position: absolute; top: 45px; color:red; font-size:12px" id="error1"></p>
                                </fieldset>

                                <fieldset style="position: relative" class="mt-3">
                                    <input type="text" id="chiTiet" class="form-control mr-1 mt-3" placeholder="Chi tiết công việc" />
                                    <p style="position: absolute; top: 45px; color:red; font-size:12px" id="error2"></p>
                                </fieldset>

                                <fieldset style="position: relative" class="mt-3">
                                    <input type="number" min="0" id="KhoiLuong" class="form-control mr-1 mt-3" placeholder="Khối lượng công việc" step="0.01" value="0.00" />
                                    <p style="position: absolute; top: 45px; color:red; font-size:12px" id="error3"></p>
                                </fieldset>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" onclick="themCongViec2()">Lưu</button>
                            </div>
                        </div>
                    </div>
                </div>
            }


            <div class="card-body table-responsive p-0">
                <table class="table table-hover text-nowrap border border-info">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Mục tiêu công việc</th>
                            <th>Deadline</th>
                            <th>Tiến độ</th>
                            <th>Trạng thái</th>
                        </tr>
                    </thead>
                    <tbody id="dvPartial">
                        @{ Html.RenderAction("dsCongViecCon", "CongViec");}
                    </tbody>
                </table>
            </div>



            <p class="mt-3 d-flex flex-row-reverse ">
                @Html.ActionLink("Edit", "Edit", new { id = Model.MaCongViec }, new { @class = "btn btn-sm btn-info " })
                <a href="/Admin/CongViec/Index" class="btn btn-sm btn-secondary mr-3">Quay lại danh sách</a>
                <a href="/Admin/DuAn/Details/@Model.tbl_DuAn.MaDuAn" class="btn btn-sm btn-secondary mr-3">Quay lại</a>
            </p>

        </div>
    </section>

}
else
{
    <h2>Hãy đợi Leader chia việc cụ thể</h2>
}

<p>
    @Html.ActionLink("Edit", "Edit", new { id = Model.MaCongViec }) |
    <a href="/DuAn/Details/@Model.MaDuAn">Quay lại</a>
</p>




@section scripts{
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&key=AIzaSyCIwF204lFZg1y4kPSIhKaHEXMLYxxuMhA"></script>
    <script src="~/Content/Admin/plugins/jquery/jquery.min.js"></script>
    <script src="~/Content/Admin/plugins/jquery-ui/jquery-ui.min.js"></script>
    <script type="text/javascript">

        $(document).ready(function () {
            //window.chiaViec2 = chiaViec2;
            window.hoanThanh = hoanThanh;
            window.daLam = daLam;
        });


        function hoanThanh(maCv) {

            alert(1);
            $.ajax({
                url: "/CongViec/HoanThanh",
                type: "POST",
                data: { MaCongViec: maCv},
                success: function (data) {
                    if (data.message) {
                        alert("Chúc mừng bạn đã hoàn thành công việc");
                        location.reload();
                    }
                    else {
                        alert("Cập nhật công việc thất bại");
                    }
                }
            });
        }

        function daLam(maCv) {
            _daLamDuoc = $("#khoiLuongDaLam").val();
            debugger
            $.ajax({
                url: "/CongViec/daLamDuoc",
                type: "POST",
                data: { MaCongViec: maCv, daLam: _daLamDuoc },
                success: function (data) {
                    alert(1);
                    if (data.message) {
                        alert("Thành công");
                        location.reload();
                    }
                    else {
                        alert("Cập nhật công việc thất bại");
                    }
                }
            });
        }


        // nhan vien start
        function SubmitForm(maCv) {
            _maCV = maCv;
            var _maNV = $("#MaNV").val();
            if (_maNV == null) {
                _maNV = $("#MaNV2").val();
            } 
            $.ajax({
                type: "POST",
                url: "/Admin/NhanVienThamGiaCongViec/addNhanVien",
                data: { maCongViec: _maCV, idNv: _maNV },
                success: function (data) {
                    if (data.message) {
                        alert("Thêm nhân viên vào công việc thành công");
                        location.reload();
                    }
                    else {
                        alert("Thêm nhân viên thất bại");
                    }
                }
            });
        }


        function deleteNhanVien(idnv) {
            _maCV = $("#MaCongViec").val();
            //_maNV = $("#maNv").val();
            //var idnv = $(this).data("maNv");
            $.ajax({
                type: "POST",
                url: "/Admin/NhanVienThamGiaCongViec/deleteNhanVien",
                data: { maCv: _maCV, maNv: idnv },
                success: function (data) {
                    if (data.message) {
                        /*alert("Xóa thành công");*/
                        location.reload();
                    }
                    else {
                        alert("Xóa thất bại");
                    }
                },
                error: function (xhr, status, error) {
                    // Hoặc:
                }
            });
        }
        // nhan vien end

        // công việc start
        function themCongViec2() {
            _maDA = $("#MaDuAn").val();
            _maCV = $("#MaCongViec").val();
            _tenCongViec = $("#tenCongViec").val();
            _chiTiet = $("#chiTiet").val();
            _deadLine = $("#KhoiLuong").val();
            $.ajax({
                url: "/Admin/CongViec/addCongViecCon",
                type: "POST",

                data: { maDa: _maDA, maCv: _maCV, tenCv: _tenCongViec, chiTiet: _chiTiet, deadLine: _deadLine },
                success: function (data) {
                    if (data.message) {
                        /*alert("Thêm nhân viên vào dự án thành công");*/
                        location.reload();
                    }
                    else {
                        alert("Thêm công việc thất bại");
                    }
                }
            });
        }


        function suaCongViec2(maCongViec2) {

            _tenCv = $("#tenCvEdit-" + maCongViec2).val();
            _chiTiet = $("#chiTietEdit-" + maCongViec2).val();

            _tg = $("#KhoiLuong-" + maCongViec2).val();


            $.ajax({
                type: "POST",
                url: "/CongViecCap2/editCongViec2",
                data: { MaCongViec: maCongViec2, tenCv: _tenCv, chiTiet: _chiTiet, tg: _tg },
                success: function (data) {

                    if (data.message) {
                        alert("Cập nhật công việc thành công");
                        location.reload();
                    }
                    else {
                        alert("Cập nhật công việc thất bại");
                    }
                }
            });
        }

        function xoaCongViec2(idCongViec) {

            $.ajax({
                type: "POST",
                url: "/CongViecCap2/deleteCongViec2",
                data: { maCongViec: idCongViec },
                success: function (data) {
                    if (data.message) {
                        /*alert("Xóa thành công");*/
                        location.reload();
                    }
                    else {
                        alert("Xóa thất bại");
                    }
                },
                error: function (xhr, status, error) {
                    // Hoặc:
                }
            });
        }




         function chiaviec2() {
            alert("được gọi");
           
        }

        @*function chiaviecgoc(callback) {
            _mada = $("#maduan").val();
            _parentid = $("macongviec").val();
            _chitiet = $("#chitiet").val();
            _muctieu = $("#muctieu").val() + "cong viec duoc chia da lam!";
            _tg = $("#thoigianhoanthanh").val();
            _tiendo = 100;
            $.ajax({
                type: "post",
                url: "/congviec/addcongvieccon",
                data: { mada: _mada, pid : _parentid, muctieu: _muctieu, chitiet: _chitiet, tg: _tg, tiendo : _tiendo },
                success: function (data) {
                    if (data.message) {
                        /*alert("thêm nhân viên vào dự án thành công");*/
                        location.reload();
                        callback(data.macongviec);
                    }
                    else {
                        alert("thêm nhân viên thất bại");
                    }
                }
            });
        }


        function viecduocchia(callback) {
            _mada = $("#maduan").val();
            _parentid = $("macongviec").val();
            _chitiet = $("#chitiet").val();
            _muctieu = $("#muctieu").val() + "cong viec duoc chia chua lam!";
            _tg = $("#khoiluong").val() - $("#thoigianhoanthanh").val();
            $.ajax({
                type: "post",
                url: "/congviec/addcongvieccon",
                data: { mada: _mada, pid : _parentid, muctieu: _muctieu, chitiet: _chitiet, tg: _tg },
                success: function (data) {
                    if (data.message) {
                        /*alert("thêm nhân viên vào dự án thành công");*/
                        location.reload();
                        callback(data.macongviec);
                    }
                    else {
                        alert("thêm nhân viên thất bại");
                    }
                }
            });
        }

        function nguoichiaviec() {
            _manv = @Session["UserID"];
            chiaviecgoc(function (macv) {
                _macv = macv;
                $.ajax({
                    type: "post",
                    url: "/nhanvienthamgiacongviec/addnhanvien",
                    data: { macongviec: _macv, idnv: _manv },
                    success: function (data) {
                        if (data.message) {
                            alert("thêm nhân viên vào công việc thành công");
                            location.reload();
                        }
                        else {
                            alert("thêm nhân viên thất bại");
                        }
                    }
                });
            });

        };
        function nguoiduocchia() {
            _manv = @Session["UserID"];
            viecduocchia(function (macv) {
                _macv = macv;
                $.ajax({
                    type: "post",
                    url: "/nhanvienthamgiacongviec/addnhanvien",
                    data: { macongviec: _macv, idnv: _manv },
                    success: function (data) {
                        if (data.message) {
                            alert("thêm nhân viên vào công việc thành công");
                            location.reload();
                        }
                        else {
                            alert("thêm nhân viên thất bại");
                        }
                    }
                });
            });

        }*@

    </script>

}


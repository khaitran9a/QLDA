@model QLDA.Models.tbl_DuAn

@{
    int userID = (int)Session["UserID"];

    var query = Model.tbl_ThamGiaDuAn.FirstOrDefault(x => x.MaDuAn == Model.MaDuAn && x.MaNV == userID);
    bool isManager = false;
    if (query.isManager != null)
    {
        isManager = (bool)query.isManager;
    }

}



<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0"></h1>
            </div><!-- /.col -->

        </div><!-- /.row -->
    </div><!-- /.container-fluid -->
</div>

@if (!isManager)
{
    <section class="content">
        <div class="container-fluid card col-md-10 m-auto">

            <div>
                <h4 class="mt-3">Chi tiết dự án</h4>
                <hr />
                <dl class="dl-horizontal">
                    <dt>
                        @Html.DisplayNameFor(model => model.TenDuAn)
                    </dt>

                    <dd>
                        @Html.DisplayFor(model => model.TenDuAn)
                    </dd>

                    <dt>
                        @Html.DisplayNameFor(model => model.Thumbnail)
                    </dt>

                    <dd>
                        @Html.DisplayFor(model => model.Thumbnail)
                    </dd>

                    <dt>
                        @Html.DisplayNameFor(model => model.KinhPhi)
                    </dt>

                    <dd>
                        @Html.DisplayFor(model => model.KinhPhi)
                    </dd>

                    <dt>
                        @Html.DisplayNameFor(model => model.ThoiGianDuKien)
                    </dt>

                    <dd>
                        @Html.DisplayFor(model => model.ThoiGianDuKien)
                    </dd>

                    <dt>
                        @Html.DisplayNameFor(model => model.NgayKhoiCong)
                    </dt>

                    <dd>
                        @Html.DisplayFor(model => model.NgayKhoiCong)
                    </dd>

                    <dt>
                        @Html.DisplayNameFor(model => model.TrangThaiDuAn)
                    </dt>

                    <dd>
                        @Html.DisplayFor(model => model.TrangThaiDuAn)
                    </dd>

                </dl>
            </div>

            <p>Danh sách công việc của bạn trong dự án</p>
            <div class="card-body table-responsive p-0">
                <table class="table table-hover text-nowrap border border-info">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Mục tiêu công việc</th>
                            <th>Chi tiết</th>
                            <th>Chức năng</th>
                        </tr>
                    </thead>
                    <tbody id="dvPartial">
                        @Html.Action("dsCongViecOfNhanVien", "DuAn")
                    </tbody>
                </table>
            </div>
           

            <p>
                @Html.ActionLink("Edit", "Edit", new { id = Model.MaDuAn }) |
                <a href="/Home/Index">Quay lại</a>
            </p>
        </div>
    </section>
}

else
{
    <h1>Đây là manager </h1>

    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0"></h1>
                </div><!-- /.col -->

            </div><!-- /.row -->
        </div><!-- /.container-fluid -->
    </div>

    <section class="content">
        <div class="container-fluid card col-md-10 m-auto">

            <div>
                <h4 class="mt-3">Chi tiết dự án</h4>
                <hr />
                <dl class="dl-horizontal">
                    @Html.HiddenFor(model => model.MaDuAn, new { @id = "MaDuAN" })
                    <dt>
                        @Html.DisplayNameFor(model => model.TenDuAn)
                    </dt>

                    <dd>
                        @Html.DisplayFor(model => model.TenDuAn)
                    </dd>

                    <dt>
                        @Html.DisplayNameFor(model => model.Thumbnail)
                    </dt>

                    <dd>
                        @Html.DisplayFor(model => model.Thumbnail)
                    </dd>

                    <dt>
                        @Html.DisplayNameFor(model => model.KinhPhi)
                    </dt>

                    <dd>
                        @Html.DisplayFor(model => model.KinhPhi)
                    </dd>

                    <dt>
                        @Html.DisplayNameFor(model => model.ThoiGianDuKien)
                    </dt>

                    <dd>
                        @Html.DisplayFor(model => model.ThoiGianDuKien)
                    </dd>

                    <dt>
                        @Html.DisplayNameFor(model => model.NgayKhoiCong)
                    </dt>

                    <dd>
                        @Html.DisplayFor(model => model.NgayKhoiCong)
                    </dd>

                </dl>
            </div>


            <form class="form-group" id="add" action="" method="post">
                <select class="col-md-10" id="MaNV" name="MaNV">
                    
                    @{ Html.RenderAction("dsNhanVien", "DuAn", new { area = "Admin" });}

                </select>

                <input type="button" value="Thêm nhân viên" id="addNhanVien" onclick="SubmitForm()" />
            </form>

            <h4>Danh sách nhân viên trong dự án</h4>
            <div class="card-body table-responsive p-0">
                <table class="table table-hover text-nowrap border border-info">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Tên nhân viên</th>
                            <th>Chức năng</th>
                        </tr>
                    </thead>
                    <tbody id="dvPartial">
                        @{ Html.RenderAction("dsNhanVienInDuAn", "DuAn");}
                    </tbody>
                </table>
            </div>


            <h4 class="mt-5">Danh sách ghi chú của dự án</h4>
            <form class="form-group d-flex" id="add" action="" method="post">
                <input type="text" id="GhiChu" class="form-control mr-1" placeholder="Nhập ghi chú!" />

                <input type="button" value="Tạo ghi chú" id="addGhiChu" onclick="ghichu()" />
            </form>
            <div class="card-body table-responsive p-0">
                <table class="table table-hover text-nowrap border border-info">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Ghi chú</th>
                            <th>Ngày ghi chú</th>
                            <th>Chức năng</th>
                        </tr>
                    </thead>
                    <tbody id="dvPartial">
                        @{ Html.RenderAction("dsGhiChu", "GhiChuDuAn", new { area = "Admin" });}
                    </tbody>
                </table>
            </div>

            <div class="d-flex justify-content-between mt-4 mb-2">

                <h4 class="">Danh sách công việc trong dự án</h4>
                <button type="button" style="height: 100%" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal">
                    Thêm công việc
                </button>

            </div>



            <!-- Button trigger modal -->
            <!-- Modal -->
            <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Thêm công việc</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <fieldset style="position: relative">
                                <input type="text" id="mucTieu" class="form-control mr-1" placeholder="Nhập mục tiêu công việc" />
                                <p style="position: absolute; top: 45px; color:red; font-size:12px" id="error1"></p>
                            </fieldset>

                            <fieldset style="position: relative" class="mt-3">
                                <input type="text" id="chiTiet" class="form-control mr-1 mt-3" placeholder="Chi tiết công việc" />
                                <p style="position: absolute; top: 45px; color:red; font-size:12px" id="error2"></p>
                            </fieldset>

                            <fieldset style="position: relative" class="mt-3">
                                <input type="number" min="0" id="thoiGianHoanThanh" class="form-control mr-1 mt-3" placeholder="Thời gian hoàn thành" step="0.01" value="0.00" />
                                <p style="position: absolute; top: 45px; color:red; font-size:12px" id="error3"></p>
                            </fieldset>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="themCongViec()">Lưu</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body table-responsive p-0">
                <table class="table table-hover text-nowrap border border-info">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Mục tiêu công việc</th>
                            <th>Deadline</th>
                            <th>Tiến độ</th>
                            <th>Trạng thái</th>
                        </tr>
                    </thead>
                    <tbody id="dvPartial">
                        @{ Html.RenderAction("dsCongViec", "CongViec");}
                    </tbody>
                </table>
            </div>
            <!-- Button trigger modal -->


            <p class="mt-3 d-flex flex-row-reverse ">
                @Html.ActionLink("Edit", "Edit", new { id = Model.MaDuAn }, new { @class = "btn btn-sm btn-info " })
                @Html.ActionLink("Quay lại", "Index", null, new { @class = "btn btn-sm btn-secondary mr-3" })
                @*<a href="/Admin/ThamGiaDuAn/Create/@Model.MaDuAn">Thêm thành viên</a>*@
            </p>
        </div>
    </section>


    @section scripts{
        <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&key=AIzaSyCIwF204lFZg1y4kPSIhKaHEXMLYxxuMhA"></script>
        <script src="~/Content/Admin/plugins/jquery/jquery.min.js"></script>
        <script src="~/Content/Admin/plugins/jquery-ui/jquery-ui.min.js"></script>
        <script>

        $(document).ready(function () {
            window.deleteNhanVien = deleteNhanVien;
            window.SubmitForm = SubmitForm;
            window.ghichu = ghichu;
            window.themCongViec = themCongViec
            window.suaCongViec = suaCongViec;
            window.setLeader = setLeader;

        });
        // nhan vien start
        function SubmitForm() {
            _maDA = $("#MaDuAN").val();
            _maNV = $("#MaNV").val();
            $.ajax({
                type: "POST",
                url: "/Admin/ThamGiaDuAn/addNhanVien",
                data: { idDa: _maDA, idNv: _maNV },
                success: function (data) {
                    if (data.message) {
                        alert("Thêm nhân viên vào dự án thành công");
                        location.reload();
                    }
                    else {
                        alert("Thêm nhân viên thất bại");
                    }
                }
            });
        }


        function deleteNhanVien(idnv) {
            _maDA = $("#MaDuAN").val();
            //_maNV = $("#maNv").val();
            //var idnv = $(this).data("maNv");
            $.ajax({
                type: "POST",
                url: "/Admin/ThamGiaDuAn/deleteNhanVien",
                data: { maDa: _maDA, maNv: idnv },
                success: function (data) {
                    if (data.message) {
                        /*alert("Xóa thành công");*/
                        location.reload();
                    }
                    else {
                        alert("Xóa thất bại");
                    }
                },
                 error: function (xhr, status, error) {
                    // Hoặc:
                }
            });
        }
        // nhan vien end

        // ghi chú start
        function ghichu() {
            _maDa = $("#MaDuAN").val();
            _ghiChu = $("#GhiChu").val();
            $.ajax({
                type: "POST",
                url: "/Admin/GhiChuDuAn/addGhiChu",
                data: { idDa: _maDa, chiTiet: _ghiChu },
                success: function (data) {
                    if (data.message) {
                        alert("Thêm ghi chú thành công");
                        location.reload();
                    }
                    else {
                        alert("Thêm ghi chú thất bại");
                    }
                }
            });

        }






        function xoaGhiChu(idGhiChu) {;
            $.ajax({
                type: "POST",
                url: "/Admin/GhiChuDuAn/deleteGhiChu",
                data: { maGhiChu: idGhiChu },
                success: function (data) {
                    if (data.message) {
                        alert("Xóa thành công");
                        location.reload();
                    }
                    else {
                        alert("Xóa thất bại");
                    }
                },
                error: function (xhr, status, error) {
                    // Hoặc:
                }
            });
        }

         // ghi chú end

        // công việc start
        function themCongViec() {
            _maDA = $("#MaDuAN").val();
            _chiTiet = $("#chiTiet").val();
            _mucTieu = $("#mucTieu").val();
            _tg = $("#thoiGianHoanThanh").val();

            error1 = $("#error1");
            if ($("#mucTieu").val() == "") {
                error1.html("Vui lòng nhập mục tiêu công việc!");
                //alert("Chưa nhập tên khách hàng");
                return;
            }

            error2 = $("#error2");
            if ($("#chiTiet").val() == "") {
                error1.html("Vui lòng nhập chi tiết công việc!");
                //alert("Chưa nhập tên khách hàng");
                return;
            }

            error3 = $("#error3");
            if ($("#thoiGianHoanThanh").val() == "") {
                error1.html("Vui lòng cho biết thời gian hoàn thành!");
                //alert("Chưa nhập tên khách hàng");
                return;
            }

            $.ajax({
                type: "POST",
                url: "/Admin/CongViec/addCongViec",
                data: { maDa: _maDA, mucTieu: _mucTieu, chiTiet: _chiTiet, tg: _tg },
                success: function (data) {
                    if (data.message) {
                        /*alert("Thêm nhân viên vào dự án thành công");*/
                        location.reload();
                    }
                    else {
                        alert("Thêm nhân viên thất bại");
                    }
                }
            });
        }



        function suaCongViec(maCongViec) {

            _chiTiet = $("#chiTietEdit-" + maCongViec).val();
            _mucTieu = $("#mucTieuEdit-" + maCongViec).val();
            _tg = $("#thoiGianHoanThanhEdit-" + maCongViec).val();



            error1 = $("#error1");
            if ($("#mucTieuEdit").val() == "") {
                error1.html("Vui lòng nhập mục tiêu công việc!");
                //alert("Chưa nhập tên khách hàng");
                return;
            }

            error2 = $("#error2");
            if ($("#chiTietEdit").val() == "") {
                error1.html("Vui lòng nhập chi tiết công việc!");
                //alert("Chưa nhập tên khách hàng");
                return;
            }

            error3 = $("#error3");
            if ($("#thoiGianHoanThanhEdit").val() == "") {
                error1.html("Vui lòng cho biết thời gian hoàn thành!");
                //alert("Chưa nhập tên khách hàng");
                return;
            }


            $.ajax({
                url: "/Admin/CongViec/editCongViec",
                type: "POST",
                data: { MaCongViec: maCongViec, mucTieu: _mucTieu, chiTiet: _chiTiet, tg: _tg },
                success: function(data) {
                    if (data.message) {
                        alert("Cập nhật công việc thành công");
                        location.reload();
                    }
                    else {
                        alert("Cập nhật công việc thất bại");
                    }
                }
            });
        }

        function xoaCongViec(MaCongViec) {

            $.ajax({
                type: "POST",
                url: "/Admin/CongViec/deleteCongViec",
                data: { maCongViec: MaCongViec },
                success: function (data) {

                    if (data.message) {
                        /*alert("Xóa thành công");*/
                        location.reload();
                    }
                    else {

                        alert("Xóa thành công!");
                        location.reload();
                    }
                },
                error: function (xhr, status, error) {
                    // Hoặc:
                }
            });
        }

        // công việc end

        function setLeader(manv) {
            $.ajax({
                type: "POST",
                url: "/Admin/CongViec/setLeader",
                data: { maNV: manv },
                success: function (data) {

                    if (data.message) {
                        alert("set thành công");
                        location.reload();
                    }
                    else {

                        location.reload();
                    }
                },
                error: function (xhr, status, error) {
                    // Hoặc:
                }
            });
        }



        </script>

    }


}

